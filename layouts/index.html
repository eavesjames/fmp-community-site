{{- define "main" }}

{{- $allPulse := where site.RegularPages "Section" "pulse" }}

{{- /* Sort: source_date desc first, then undated by .Date desc */ -}}
{{- $withDate := slice }}
{{- $noDate   := slice }}
{{- range $allPulse }}
  {{- if isset .Params "source_date" }}
    {{- $withDate = $withDate | append . }}
  {{- else }}
    {{- $noDate = $noDate | append . }}
  {{- end }}
{{- end }}
{{- $withDateSorted := sort $withDate "Params.source_date" "desc" }}
{{- $noDateSorted   := $noDate.ByDate.Reverse }}
{{- $sorted := $withDateSorted }}
{{- range $noDateSorted }}
  {{- $sorted = $sorted | append . }}
{{- end }}

{{- $sections := slice
  (dict "key" "edge-power-ups"           "label" "Edge Infrastructure Power &amp; UPS")
  (dict "key" "data-centers"             "label" "Data Centers")
  (dict "key" "building-electrification" "label" "Building Electrification / Decarbonization")
}}

{{- $cutoffDate := now.AddDate 0 0 -10 }}
{{- $cutoffStr  := $cutoffDate.Format "2006-01-02" }}

<div class="rcp-home">

  {{/* ── Latest by Topic Area: stacked verticals ── */}}
  <section class="rcp-verticals-section">
    <h2 class="rcp-section-title">Latest by Topic Area</h2>
    {{- range $sections }}
      {{- $key   := .key }}
      {{- $label := .label }}
      {{- $allItems  := where $sorted "Params.vertical" $key }}
      {{- $recentItems := where $allItems "Params.source_date" "ge" $cutoffStr }}
      {{- $items := first 6 $recentItems }}
      <div class="rcp-vertical-section">
        <h3 class="rcp-vertical-title">
          <a href="/verticals/{{ $key }}/" class="rcp-vertical-link">{{ $label | safeHTML }}</a>
        </h3>
        {{- if $items }}
          {{- range $items }}
            {{- partial "rcp_row.html" . }}
          {{- end }}
        {{- else }}
          {{- if $allItems }}
            <p class="rcp-empty">No updates in the last 10 days — <a href="/verticals/{{ $key }}/">see all →</a></p>
          {{- else }}
            <p class="rcp-empty">Items coming soon.</p>
          {{- end }}
        {{- end }}
      </div>
    {{- end }}
  </section>

  {{/* ── Originals strip ── */}}
  {{- $originals := where site.RegularPages "Section" "originals" }}
  {{- $originals  = $originals.ByDate.Reverse }}
  {{- if $originals }}
  <section class="rcp-originals-section">
    <h2 class="rcp-section-title">Originals</h2>
    <div class="rcp-originals-strip">
      {{- range first 3 $originals }}
      <div class="rcp-original-card">
        <span class="rcp-date">{{ .Date.Format "2006-01-02" }}</span>
        <a href="{{ .Permalink }}" class="rcp-title">{{ .Title }}</a>
        {{- if .Params.thesis }}
        <p class="rcp-thesis">{{ .Params.thesis }}</p>
        {{- end }}
      </div>
      {{- end }}
    </div>
  </section>
  {{- end }}

  {{/* ── Main stream: recent pulse items with archive link ── */}}
  <section class="rcp-stream-section">
    <h2 class="rcp-section-title">All Updates <a href="/pulse/" class="rcp-archive-link">full archive →</a></h2>
    <div class="rcp-stream">
      {{- range first 20 $sorted }}
        {{- partial "rcp_row.html" . }}
      {{- end }}
    </div>
  </section>

</div>

{{- end }}
